<!DOCTYPE html>
<html lang="fr">
<head>
	<title>COMP JS - Interface</title>

	<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- BootStrap 4 CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<!-- FontAwesome CSS -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
	<!-- CodeMirror CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.29.0/codemirror.css">
	<!-- Custom CSS -->
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<!-- INPUT WHILE -->
			<div class="offset-lg-2 col-lg-4">
				<div class="row">
					<img src="while_logo.png" class="logoLg img-fluid mx-auto d-block" alt="Logo WHILE"/>
				</div>
				<div class="row">
					<textarea class="form-control" id="whileToCompile" rows="25"></textarea>
				</div>
				<div class="row my-4">
					<button type="button" class="btn btn-outline-secondary btn-lg mx-auto d-block" name="validateCompile" id="validateCompile"><i class="fas fa-cogs"></i>&nbsp;Compiler</button>
				</div>
			</div>
			<!-- OUTPUT JAVASCRIPT -->
			<div class="col-lg-4">
				<div class="row">
					<img src="js_logo.png" class="logoLg img-fluid mx-auto d-block" alt="Logo JavaScript"/>
				</div>
				<div class="row">
					<textarea class="form-control" id="jsCompiled" rows="25"></textarea>
				</div>
				<div class="row my-4">
					<button type="button" class="btn btn-outline-secondary btn-lg mx-auto d-block" name="execute" id="execute"><i class="fas fa-play"></i>&nbsp;Exécuter</button>
				</div>
			</div>
		</div>
		<div class="row my-5">
			<!-- OUTPUT CONSOLE -->
			<div class="offset-lg-4 col-lg-4">
				<textarea disabled class="form-control" id="consoleOutput" rows="12" placeholder="Console output..."></textarea>
			</div>
		</div>
	</div>

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<!-- Popper JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<!-- CodeMirror JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.29.0/codemirror.js"></script>
	<!-- BootStrap 4 JS -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<script>
    	window.onload = function () {
			var whileEditor = CodeMirror.fromTextArea($("#whileToCompile")[0], {
			  lineNumbers: true,
			  lineWrapping: true,
			});
			var jsEditor = CodeMirror.fromTextArea($("#jsCompiled")[0], {
			  lineNumbers: true,
			  lineWrapping: true,
			});

			$('#validateCompile').on('click', function(event){
			event.preventDefault();
			var debugMode = false;
			if($('#showThreeAdressesCode').is(":checked")) {
			  debugMode = true;
			}
			var codeWh = whileEditor.getValue();
			$.ajax({
			  url: '/compile',
			  type: 'POST',
			  dataType: 'json',
			  data: {whilePrgm: codeWh, debugMode: debugMode},
			  success: (data) => {
			    $('#consoleOutput').html(data.jarPrints);
			    $.ajax({
			      url: '/output',
			      type: 'GET',
			      success: (data) => {
			        console.log(data);
			        jsEditor.setValue("");
			        jsEditor.clearHistory();
			        jsEditor.replaceSelection(data.compiledJS);
			        $('#execute').removeClass('disabled');
			        //$('#jsCompiled').html(data.compiledJS);
			      }
			    });
			    $.ajax({
			      url: '/parameters',
			      type: 'GET',
			      success: (data) => {
			        if(data.error){
			          $('#consoleOutput').append(data.error);
			        }else if(data.params){
			          generateInputAreas(data.params);
			          listenExecClick(jsEditor);
			        }
			      }
			    });
			  }
			});
			});
		};

	    //params should be array of the function parameters
	    function generateInputAreas(params) {
	      	$('#paramInputs').html('<span class="h4 text-muted">Paramètres d\'exécution</span>');
	      	for (var i = 0; i < params.length; i++) {
	        	var current = params[i];
	        	$('#paramInputs').append('<div class="col-md-12">\
	                                  <label for="'+ current +'">'+ current +'</label>\
	                                  <input id="'+ current +'" name="'+ current +'" class="form-control parameter" type="text" placeholder="Valeur pour '+ current +'">\
	                                  </div>');
	      	}
	    }

		function listenExecClick(jsEditor){
		    // listen for click (put this in another function)
		   	$('#execute').on('click', function(event){
			    var jsCode = jsEditor.getValue();
			    var arrayValues = {};
			    $('input.parameter').each(function(index,data) {
			        arrayValues[$(this).attr('id')] = $(this).val();  // key = nom de la variable, value = la valeur rentrée dans l'input
			    });
			    console.log(arrayValues);
			    $.ajax({
			        url: '/runCompiled',
			        type: 'POST',
			        dataType: 'json',
			        data: {
			          	code:  jsCode,
			            param: arrayValues
			        },
			        success: (data) => {
			            console.log(data);  // voilà l'output théo affiche ça bien stp merci faut faire mieux que la team typescript  /!\
			            $('#execOutput').empty();
			            var outInt = data.outInt;
			            var outString = data.outString;
			            for(var i = 0; i < outInt.length; i++) {
			              	$('#execOutput').append('{<br>');
			              	$('#execOutput').append('<strong style="padding:0 0 0 20px;">BinTree : </strong>' + outString[i] + ',<br>');
			              	$('#execOutput').append('<strong style="padding:0 0 0 20px;">Int : </strong>' + outInt[i] + '<br>');
			              	$('#execOutput').append('}<br>');
			            }
			        }
			    });
		    });
	  	}
    </script>
</body>
</html>
