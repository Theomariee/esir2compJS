<!DOCTYPE html>
<html lang="fr">
<head>
	<title>COMP JS - Interface</title>

	<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- BootStrap 4 CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<!-- FontAwesome CSS -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
	<!-- CodeMirror CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.29.0/codemirror.css">
	<!-- Ubuntu Font -->
	<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
	<!-- Custom CSS -->
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div class="container-fluid">
	    <form method="POST" id="compilation">
			<div class="row">
				<!-- INPUT WHILE -->
				<div class="offset-lg-2 col-lg-4">
					<div class="row">
						<img src="while_logo.png" class="logoLg img-fluid mx-auto d-block" alt="Logo WHILE"/>
					</div>
					<div class="row">
						<textarea class="form-control" id="whileToCompile" rows="25"></textarea>
					</div>
					<div class="row my-4">
						<button type="button" class="btn btn-outline-secondary btn-lg mx-auto d-block" name="validateCompile" id="validateCompile"><i class="fas fa-cogs"></i>&nbsp;Compiler</button>
					</div>
				</div>
				<!-- OUTPUT JAVASCRIPT -->
				<div class="col-lg-4">
					<div class="row">
						<img src="js_logo.png" class="logoLg img-fluid mx-auto d-block" alt="Logo JavaScript"/>
					</div>
					<div class="row">
						<textarea class="form-control" id="jsCompiled" rows="25"></textarea>
					</div>
					<div class="row my-4">
						<button type="button" class="btn btn-outline-secondary btn-lg mx-auto d-block" name="execute" id="execute"><i class="fas fa-play"></i>&nbsp;Exécuter</button>
					</div>
				</div>
			</div>
			<div class="row my-5">
				<!-- OUTPUT CONSOLE -->
				<div class="offset-lg-4 col-lg-4">
					<textarea disabled class="form-control" id="consoleOutput" rows="12" placeholder="Console output..."></textarea>
					<button type="button" class="btn btn-primary mx-auto d-block my-3 disabled" data-toggle="modal" data-target="#exampleModal" id="execParams">
						Paramètres
					</button>

					<!-- Modal input boxes -->
					<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
					  	<div class="modal-dialog" role="document">
					    	<div class="modal-content">
					      	<div class="modal-header">
					        	<h5 class="modal-title" id="exampleModalLabel">Donner une valeurs aux paramètres d'appel</h5>
					        	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					          	<span aria-hidden="true">&times;</span>
					        	</button>
					      	</div>
					      	<div class="modal-body">
						        <div id="paramInputs">
					            </div>
					      	</div>
					      	<div class="modal-footer">
					        	<button type="button" class="btn btn-secondary" data-dismiss="modal">Ok</button>
					      	</div>
					    	</div>
					  	</div>
					</div>
				</div>
			</div>
		</form>
	</div>



	<!-- jQuery -->
  	<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
	<!-- Popper JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<!-- CodeMirror JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.29.0/codemirror.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.29.0/mode/javascript/javascript.js"></script>
	<!-- BootStrap 4 JS -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<script>
		window.onload = function () {
			var whileEditor = CodeMirror.fromTextArea($("#whileToCompile")[0], {
				lineNumbers: true,
				lineWrapping: true,
			});
			var jsEditor = CodeMirror.fromTextArea($("#jsCompiled")[0], {
				lineNumbers: true,
				lineWrapping: true,
				readOnly: 'nocursor'
			});

			listenCompileClick();

			function listenCompileClick() {
				$('#validateCompile').on('click', function(event){
					$('#consoleOutput').empty();
					jsEditor.setValue("");
					jsEditor.clearHistory();

					var debugMode = true;
					var codeWh = whileEditor.getValue();

					$.ajax({
						url: '/compile',
						type: 'POST',
						dataType: 'json',
						data: {whilePrgm: codeWh, debugMode: debugMode},
						success: (data) => {
							$('#consoleOutput').html(data.jarPrints);

							$.ajax({
								url: '/output',
								type: 'GET',
								success: (data) => {
									jsEditor.replaceSelection(data.compiledJS);
									$('#execParams').removeClass('disabled');
								}
							});

							$.ajax({
								url: '/parameters',
								type: 'GET',
								success: (data) => {
									if(data.error){
										$('#consoleOutput').append(data.error);
									}else if(data.params){
										generateInputAreas(data.params);
										listenExecClick(jsEditor);
									}
								}
							});
						}
					});
				});
			}

			//params should be array of the function parameters
			function generateInputAreas(params) {
				$('#paramInputs').html('');
				for (var i = 0; i < params.length; i++) {
					var current = params[i];
					$('#paramInputs').append('<div class="col-md-12 my-2">\
						<label for="'+ current +'">'+ current +'</label>\
						<input id="'+ current +'" name="'+ current +'" class="form-control parameter" type="text" placeholder="Valeur pour '+ current +'">\
						</div>');
				}
				$('#exampleModal').modal('show'); 
			}

			function listenExecClick(jsEditor){
				$("#execute").unbind('click');	// remove old click bind if compiled button was clicked twice without reloading page
				$('#execute').on('click', function(event){
					var arrayValues = {};
					$('input.parameter').each(function(index,data) {
						arrayValues[$(this).attr('id')] = $(this).val();  // key = nom de la variable, value = la valeur rentrée dans l'input
					});
					
					$.ajax({
						url: '/runCompiled',
						type: 'POST',
						dataType: 'json',
						data: {
							params: arrayValues
						},
						success: (data) => {
							var outInt = data.outInt;
							var outString = data.outString;
							for(var i = 0; i < outInt.length; i++) {
								$('#consoleOutput').append('\n------------------\n');
								$('#consoleOutput').append('Résultat de l\'exécution :\n');
								$('#consoleOutput').append('{\n');
								$('#consoleOutput').append('BinTree : ' + outString[i] + ',\n');
								$('#consoleOutput').append('Int : ' + outInt[i] + '\n');
								$('#consoleOutput').append('}\n');
							}
						}
					});
				});
			}
		};
    </script>
</body>
</html>
